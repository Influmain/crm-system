# Claude 코드 검증 및 호환성 확인 규칙

## 개발 시작 전 필수 검증 프로세스

### 1단계: 기존 코드 구조 파악 (필수)

**반드시 요청할 파일들:**
```
"다음 파일들을 먼저 보여주세요. 기존 구조를 파악한 후 개발하겠습니다:

1. 관련 기존 페이지 (수정 대상 또는 유사 기능)
2. /lib/auth/AuthContext.tsx (인증 관련 기능인 경우)
3. /components/layout/[해당Layout].tsx (레이아웃 사용하는 경우)
4. /components/ui/Toast.tsx (사용자 피드백 필요한 경우)

기존 코드 없이는 개발을 시작하지 않겠습니다."
```

### 2단계: 데이터 구조 호환성 확인

**데이터베이스 관련 기능 개발 시 확인사항:**

```typescript
// v6 중복 제거 패턴 준수 확인
"기존 코드에서 다음 패턴을 사용하는지 확인:
- assignment별 최신 기록만 사용하는가?
- flatMap().reduce() 같은 중복 집계를 하고 있지 않은가?
- counseling_activities에서 contact_date 기준 정렬하는가?"

// 확인할 쿼리 패턴
const latestActivity = activities
  .sort((a, b) => new Date(b.contact_date) - new Date(a.contact_date))[0];
```

### 3단계: AuthContext 호환성 확인

**인증 관련 기능 개발 시 필수 확인:**

```typescript
// 현재 AuthContext 구조 확인
"현재 useAuth()에서 제공하는 정확한 구조는:
- { user, userProfile, loading } 인가?
- 재시도 로직이 내장되어 있는가?
- 리다이렉트 로직은 어떻게 구현되어 있는가?"

// 금지: AuthContext 내부 로직 수정
// 허용: useAuth() hook 사용만
```

### 4단계: 토스트 시스템 호환성 확인

**사용자 피드백이 필요한 기능 개발 시:**

```typescript
// 현재 토스트 사용 패턴 확인
"기존 코드에서 토스트를 어떻게 사용하는지 확인:
- useToastHelpers() 사용하는가?
- success, error, warning 메서드 구조는?
- action 버튼 패턴은 어떻게 구현되어 있는가?"

// 절대 사용 금지
alert(), confirm(), prompt()

// 반드시 사용
toast.success(), toast.error(), toast.warning()
```

### 5단계: 디자인 시스템 호환성 확인

**UI 컴포넌트 개발 시 확인사항:**

```typescript
// 색상 시스템 확인
"기존 코드에서 사용하는 색상 클래스 패턴:
- text-text-primary, bg-bg-primary 형태인가?
- 하드코딩 색상(text-red-500)은 없는가?
- 아이콘은 이모지를 사용하는가?"

// 절대 금지
"text-red-500", "bg-blue-600", "border-gray-300"

// 반드시 사용  
"text-text-primary", "bg-bg-primary", "border-border-primary"
```

### 6단계: 성능 및 페이징 확인

**대용량 데이터 처리 기능 개발 시:**

```typescript
// 기존 페이징 구현 확인
"대용량 데이터를 다루는 기존 페이지가 있다면:
- 서버사이드 페이징을 사용하는가?
- 페이지 크기는 몇 개인가? (기본 50개)
- range() 함수를 사용하는가?
- count: 'exact' 옵션을 사용하는가?"

// 50개 이상 데이터는 반드시 페이징
const { data, count } = await supabase
  .from('table')
  .select('*', { count: 'exact' })
  .range(startIndex, endIndex);
```

## 코드 제안 전 최종 검증 체크리스트

### 필수 확인사항 (모든 항목 통과 필수)

- [ ] **기존 코드 구조**: 유사한 기능의 파일 구조를 그대로 따르는가?
- [ ] **import 패턴**: 기존 페이지와 동일한 import 순서와 구조인가?
- [ ] **AuthContext 사용**: 현재 버전의 useAuth() 구조를 정확히 사용하는가?
- [ ] **토스트 시스템**: 기존과 동일한 useToastHelpers() 패턴인가?
- [ ] **디자인 시스템**: 하드코딩 색상 없이 시스템 변수만 사용하는가?
- [ ] **데이터 처리**: v6 중복 제거 패턴을 정확히 적용하는가?
- [ ] **페이징 처리**: 대용량 데이터 시 서버사이드 페이징을 사용하는가?
- [ ] **Hydration 방지**: mounted 패턴이 필요한 경우 적용했는가?
- [ ] **용어 통일**: 영업사원/고객/전문가 용어를 일관되게 사용하는가?
- [ ] **에러 처리**: try-catch와 토스트를 적절히 조합했는가?

### 금지사항 재확인 (하나라도 위반 시 즉시 수정)

```typescript
// 절대 사용 금지 패턴들
❌ alert("메시지")
❌ confirm("확인하시겠습니까?")  
❌ "text-red-500", "bg-blue-600"
❌ flatMap().reduce() // 중복 집계
❌ 전체 데이터 한번에 로드 (100개 이상)
❌ AuthContext 내부 로직 수정
❌ process.env 직접 조건부 렌더링
❌ "상담원", "리드" 용어 사용
```

## 검증 실패 시 대응 방법

### 기존 코드와 불일치 시
```
"기존 [파일명] 코드를 다시 확인하겠습니다. 
현재 제안한 구조가 기존 패턴과 다른 부분:
- [구체적 차이점]

기존 패턴에 맞춰 다시 제안하겠습니다."
```

### 호환성 문제 발견 시
```
"현재 제안이 다음과 호환되지 않습니다:
- AuthContext v8 구조
- 토스트 시스템 패턴  
- v6 중복 제거 로직

호환 가능한 방식으로 수정하겠습니다."
```

### 성능 문제 우려 시
```
"대용량 데이터 처리를 고려하여:
- 서버사이드 페이징 적용
- 인덱스 활용 쿼리 사용
- 로딩 상태 적절히 표시

성능 최적화된 방식으로 제안하겠습니다."
```


## 검증 원칙 (예외 없음)

1. **기존 우선**: 새로운 패턴보다 기존 코드 패턴 우선 적용
2. **호환성 필수**: 현재 시스템과 100% 호환되는 코드만 제안
3. **성능 고려**: 대용량 데이터 처리 시 반드시 최적화 적용
4. **일관성 유지**: 프로젝트 전체 코딩 스타일과 구조 일치
5. **단계적 확인**: 각 단계별 검증 완료 후 다음 단계 진행

**이 검증 과정을 생략하거나 추측으로 진행하는 것은 절대 금지합니다.**

